#!/bin/sh

SRC=$(pwd)/src
DST=$(pwd)/dst
DRAFTS=$(pwd)/src/drafts
TEMPLATES=$(pwd)/templates
ENTRIES=$(pwd)/dst/entries
SITE="example.com"

[ -z "$EDITOR" ] && EDITOR=/usr/bin/nano

[ -f "$SRC" ] || mkdir -p "$SRC"
[ -f "$DST" ] || mkdir -p "$DST"
[ -f "$DRAFTS" ] || mkdir -p "$DRAFTS"
[ -f "$ENTRIES" ] || mkdir -p "$ENTRIES"
[ -f "$TEMPLATES" ] || mkdir -p "$TEMPLATES"

# Make a new blog entry
newpost () {
        filepath="$SRC/$1.md";
        if [ -f "$filepath" ]; then
                printf "%s Already exists!\n" "$1";
        else
                DATE=$(date --rfc-3339="ns" | cut -d'.' -f1);
                "$EDITOR" "$filepath";
                printf "add to (d)rafts/(r)emove/add to (e)ntry queue\n[d/r/e]: ";
                sed -i -e "1s/^/<!---the creation date is: $DATE --->\n/" \
                       -e "1s/^/<!---Generated by esbu--->\n/" "$filepath";
                read -r choice;
                case "$choice" in 
                        d|D) mv "$filepath" "$DRAFTS"/"$1".md; printf "Added to drafts\n";;
                        e|E) printf "Added to src, ready to finalize\n" ;;
                        r|R) printf "Are you sure? [y/N]: ";
                           read -r c;
                           case "$c" in
                                   y|Y) rm "$filepath";;
                                   *) printf "Not Removed.\n";;
                           esac;;
                        *) printf "Invalid Option. added to queue\n";;
                esac
        fi
}
editpost() {
        filepath="$SRC/$1.md";
        if [ -f "$filepath" ]; then
                [ -f "$ENTRIES/$1.html" ] && rm "$ENTRIES/$1.html"
                "$EDITOR" "$filepath";
        else
                printf "%s Doesn't exist!\n" "$1"
                printf "List of entries:\n"
                find "$SRC" -maxdepth 1 -type f -exec basename {} \; | cut -d'.' -f1;

        fi
}
# Edit existing drafts
editdrafts () {
        if [ -z "$1" ]; then
                printf "No draft selected.\nDrafts:\n"
                find "$DRAFTS" -type f -exec basename {} \; | cut -d'.' -f1
                printf "\nexample : esbu draft *Draft-Name*\n"
                exit
        else
                "$EDITOR" "$DRAFTS"/"$1".md
                printf "add the draft to entry queue? [y/N]: "
                read -r choice;
                case $choice in
                        y|Y) mv "$DRAFTS"/"$1".md "$SRC"/"$1".md
                           printf "moved draft to src.ready to finalize\n";;
                        n|N) printf "Draft remains.\n";;
                        *) printf "Invalid Option\n";;
                esac
        fi
}


# Get date from already published entry
getdate () {
        filedir=$(echo "$1" | sed -e "s/dst\/entries/src/" -e "s/\.html/\.md/")
        date -R -d "$(grep -h -m 1 "the creation date is: " "$filedir" | sed -e "s/<\!---the creation date is: //" -e "s/--->//g")" | cut -c -16 | cut -c 6-; 
}

# Add index summary of posts
addsummary () {
        cat "$TEMPLATES"/index.html > "$DST"/index.html
        # Take 5 of the latest posts and order them from new to oldest.
        for t in $(echo "$LATEST" | tail -n5);
        do
                DATE=$(getdate "$t")
                filename=$(basename "$t")
                # Use the first markdown heading as the Title.
                TITLE=$(grep -m 1 "#" "$SRC"/"${filename%.html}".md | tr -d '#' )
                sed -i "/%ENTRIES%/a <li>$DATE -<a href='https://$SITE/entries/$filename'> $TITLE <\/a><\/li>\\n" "$DST"/index.html
        done
        sed -i "s/%ENTRIES%//" "$DST"/index.html;
        sed -i "s/%DATE%/$DATE/" "$DST"/index.html; 
}

# Sort .md files in $SRC in order of creation time
sortfiles() {
        #Don't sort if there's only one entry.
        size=$(find $SRC -maxdepth 1 -type f -name "*.md" | wc -l )
        if [ $size = 1 ]; then
                find "$SRC" -maxdepth 1 -type f -name "*.md" -exec basename {} \;   
        else  
                #Create a list of entries alongside their creation date seperated by spaces, each at a new line
                LIST=$(find "$SRC" -maxdepth 1 -type f -print0 | xargs -0 grep -m 1 "the creation date is:" | sed -e "s:.*/\(.*\):\1:g" -e "s/:<\!---the creation date is://" -e "s/ --->//g" );
                # Iterate over the sorted dates, find the corresponding entry and print it.
                for d in $( echo "$LIST" | sed -e "s/.*\.md //" | sort -n -k3 | tr " " "." ); do
                        date=$(echo "$d" | tr "." " ");
                        echo "$LIST" | grep "$date" | cut -d' ' -f1;
                done
        fi
}

# Create the "blogpage" which is a rolling view of blog posts.
blogpage () {
        cat "$TEMPLATES"/blogpage.html > "$DST"/blogpage.html;
        for t in $LATEST;
        do
                DATE=$(getdate "$t") # Set the date
                filename=$(basename "$t");
                # Use the first markdown heading as the Title.
                TITLE=$(grep -m 1 "#" "$SRC"/"${filename%.html}".md | tr -d '#' )
                sed -i "/%ENTRIES%/a <li><a href='https://$SITE/entries/$filename'>$DATE : $TITLE <\/a><\/li>\\n" "$DST"/blogpage.html; 
        done
        sed -i "s/%ENTRIES%//" "$DST"/blogpage.html;
}

# Adds a blog post to rss.xml
additem () {
        DATE=$(date -R -d "$(grep -h -m 1 "the creation date is: " "$1" | sed -e "s/<\!---the creation date is: //" -e "s/--->//g")" )

        TITLE=$(grep -m 1 "#" "$1" | tr -d '#' ); # Use the first heading as the Title.

        cat "$TEMPLATES"/item.xml >> "$DST"/rss.xml;
        sed -i -e "s:%NAME%:$NAME:" \
            -e "s/%URL%/entries\/${2%.md}.html/" \
            -e "s/%DATE%/$DATE/" -e "s/%CONTENT%]]><\/description>//" "$DST"/rss.xml;

        cat "$3" >> "$DST"/rss.xml;
        sed -i -e 's/\/> <!---height=//g' \
            -e 's/px--->/\/>/g' "$DST"/rss.xml;

        echo "]]></description>" >> "$DST"/rss.xml;
        echo "</item>" >> "$DST"/rss.xml;
}

# Make new individual entry
makepage () { 
        NAME=$(grep -m 1 "#" "$SRC/$1" | tr -d '#' ); # Use the first heading as the Name.

        sed "/%CONTENT%/r $2" "$TEMPLATES"/entry.html \
                | sed -e 's/%CONTENT%//' \
                        -e "s:%TITLE%:$NAME:" \
                        > "$ENTRIES"/"${1%.md}".html
}

# Take all markdown files in src/ (excluding drafts) and create corresponding html files in entries/,
# also creates/updates rss feed , blogpage and index.html
finalize () {
        head -n -3 "$TEMPLATES"/rss.xml > "$DST"/rss.xml # initialize rss.xml to add items to later

        # Take all of the latest posts and order them from new to oldest.
        LATEST=$(sortfiles | sed -e "s:^:$ENTRIES/:g" -e "s/\.md/\.html/g" )

        # sort .md files by time from oldest to newest.
        FILES=$(sortfiles | sed -e "s:^:$SRC/:g" | tac)
        for entry in $FILES;
        do
                file=$(basename "$entry");
                RAWHTML=$ENTRIES/${file%.md}-tmp.html;
               
                markdown -f fencedcode "$entry" | \
                        sed -e 's/\/> <!---height=/ style="width:100%;height:auto;max-width:/g' \
                            -e 's/px--->/px" \/>/g' > "$RAWHTML";
               
                [ -f "$ENTRIES"/"${file%.md}".html ] || makepage "$file" "$RAWHTML";
                additem "$entry" "$file" "$RAWHTML" # Add entry to rss.xml 
                [ -f "$RAWHTML" ] && rm "$RAWHTML" 
        done

        echo "</channel>" >> "$DST"/rss.xml
        echo "</rss>" >> "$DST"/rss.xml
        addsummary;
        blogpage;
}

case $1 in
        n|new)    newpost "$2";; # Create a new markdown entry
        e|edit)    editpost "$2";; # Create a new markdown entry
        l|list)   printf "List of entries:\n"
                find "$SRC" -maxdepth 1 -type f -exec basename {} \; | cut -d'.' -f1;;
        d|draft)  editdrafts "$2";;
        r|remove) rm "$ENTRIES"/"$2".html
                rm "$SRC"/"$2".md \
                        && printf "Removed %s from entries\n" "$2" \
                        || printf "\n%s doesn't exist\n" "$2";;
        f|finalize) finalize;;
        *)      printf "esbu OPTION arg1 [arg2]\n"
                printf "OPTIONS:\n"
                printf "\tn, new - create new blog post\n"
                printf "\te, edit - edit already existing blog posts\n"
                printf "\tl, list - list all blog entries\n"
                printf "\td, draft - edit drafts\n"
                printf "\tf, finalize - finalize blog - ready to deploy\n"
                printf "\tr, remove - remove a given entry name\n"
                printf "EXAMPLES:\n"
                printf "\tesbu new newpost  => creates a new entry as newpost.md\n"
                printf "\tesbu list =>  lists all entries\n"
                printf "\tesbu r newpost => removes newpost\n";;
esac
exit $?
